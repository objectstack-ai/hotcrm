# Opportunity Object Definition
# Follows @objectstack/spec standard for enterprise CRM

name: Opportunity
label: å•†æœº
labelPlural: å•†æœº
icon: briefcase
description: é”€å”®å•†æœºå’Œç®¡é“ç®¡ç†

# Enable core features
features:
  searchable: true
  trackFieldHistory: true
  enableActivities: true
  enableNotes: true
  enableAttachments: true

# Field Definitions
fields:
  # Basic Information
  - name: Name
    type: text
    label: å•†æœºåç§°
    required: true
    searchable: true
    length: 120
    
  - name: AccountId
    type: lookup
    label: å®¢æˆ·
    referenceTo: Account
    required: true
    
  - name: ContactId
    type: lookup
    label: ä¸»è¦è”ç³»äºº
    referenceTo: Contact
    
  # Sales Information
  - name: Amount
    type: currency
    label: é‡‘é¢
    precision: 2
    
  - name: CloseDate
    type: date
    label: é¢„è®¡æˆäº¤æ—¥æœŸ
    required: true
    
  - name: Stage
    type: select
    label: é˜¶æ®µ
    required: true
    options:
      - label: ğŸ” æ½œåœ¨å®¢æˆ·
        value: Prospecting
        probability: 10
      - label: ğŸ“ éœ€æ±‚ç¡®è®¤
        value: Qualification
        probability: 20
      - label: ğŸ’¡ æ–¹æ¡ˆè®¾è®¡
        value: Needs Analysis
        probability: 40
      - label: ğŸ“Š æ–¹æ¡ˆå±•ç¤º
        value: Proposal
        probability: 60
      - label: ğŸ’° å•†åŠ¡è°ˆåˆ¤
        value: Negotiation
        probability: 80
      - label: âœ… æˆäº¤
        value: Closed Won
        probability: 100
        isWon: true
      - label: âŒ å¤±è´¥
        value: Closed Lost
        probability: 0
        isLost: true
        
  - name: Probability
    type: percent
    label: èµ¢å•æ¦‚ç‡
    
  - name: Type
    type: select
    label: å•†æœºç±»å‹
    options:
      - label: æ–°ä¸šåŠ¡
        value: New Business
      - label: ç°æœ‰ä¸šåŠ¡æ‰©å±•
        value: Existing Business
      - label: ç»­çº¦
        value: Renewal
        
  # Competition & Strategy
  - name: LeadSource
    type: select
    label: çº¿ç´¢æ¥æº
    options:
      - label: Web
        value: Web
      - label: ç”µè¯å’¨è¯¢
        value: Phone Inquiry
      - label: åˆä½œä¼™ä¼´æ¨è
        value: Partner Referral
      - label: å·²è´­å®¢æˆ·æ¨è
        value: Customer Referral
      - label: å±•ä¼š
        value: Trade Show
      - label: å¸‚åœºæ´»åŠ¨
        value: Marketing Campaign
      - label: å…¶ä»–
        value: Other
        
  - name: NextStep
    type: text
    label: ä¸‹ä¸€æ­¥è¡ŒåŠ¨
    length: 255
    
  - name: CompetitorAnalysis
    type: textarea
    label: ç«äº‰åˆ†æ
    rows: 5
    
  # Forecast
  - name: ForecastCategory
    type: select
    label: é¢„æµ‹åˆ†ç±»
    options:
      - label: å·²æ‰¿è¯º
        value: Commit
      - label: æœ€å¯èƒ½
        value: Best Case
      - label: ç®¡é“
        value: Pipeline
      - label: å·²çœç•¥
        value: Omitted
        
  - name: IsWon
    type: formula
    label: æ˜¯å¦èµ¢å•
    returnType: checkbox
    formula: Stage = "Closed Won"
    
  - name: IsClosed
    type: formula
    label: æ˜¯å¦å·²å…³é—­
    returnType: checkbox
    formula: OR(Stage = "Closed Won", Stage = "Closed Lost")
    
  # Product Information
  - name: ProductInterest
    type: text
    label: æ„Ÿå…´è¶£çš„äº§å“
    length: 255
    
  - name: Quantity
    type: number
    label: æ•°é‡
    
  - name: Discount
    type: percent
    label: æŠ˜æ‰£
    
  # Other
  - name: Description
    type: textarea
    label: æè¿°
    rows: 5
    
  - name: LossReason
    type: select
    label: å¤±è´¥åŸå› 
    options:
      - label: ä»·æ ¼è¿‡é«˜
        value: Price
      - label: åŠŸèƒ½ä¸æ»¡è¶³
        value: Features
      - label: æ—¶æœºä¸å¯¹
        value: Timing
      - label: ç«äº‰å¯¹æ‰‹
        value: Competitor
      - label: é¢„ç®—ä¸è¶³
        value: Budget
      - label: å…¶ä»–
        value: Other
    visibleWhen:
      field: Stage
      operator: equals
      value: Closed Lost
      
  # Ownership
  - name: OwnerId
    type: lookup
    label: è´Ÿè´£äºº
    referenceTo: User
    required: true
    defaultValue: $currentUser
    
  # AI Analysis Field (AI å¢å¼ºåŠŸèƒ½)
  - name: AISummary
    type: textarea
    label: AI èµ¢å•åˆ†æ
    readonly: true
    length: 5000
    description: AI è‡ªåŠ¨åˆ†æå•†æœºèµ¢å•æ¦‚ç‡å’Œå»ºè®®
    
  - name: AINextStepSuggestion
    type: textarea
    label: AI ä¸‹ä¸€æ­¥å»ºè®®
    readonly: true
    length: 2000
    description: AI å»ºè®®çš„æœ€ä½³è·Ÿè¿›è¯æœ¯å’Œè¡ŒåŠ¨
    
  - name: AIWinProbability
    type: percent
    label: AI èµ¢å•é¢„æµ‹
    readonly: true
    description: åŸºäºå†å²æ•°æ®é¢„æµ‹æœ¬å•æˆåŠŸç‡
    
  - name: AIRiskFactors
    type: textarea
    label: AI é£é™©å› ç´ 
    readonly: true
    length: 2000
    description: è¯†åˆ«çš„æ½œåœ¨é£é™©å’Œåº”å¯¹å»ºè®®
    
  - name: AICompetitiveIntel
    type: textarea
    label: AI ç«äº‰æƒ…æŠ¥
    readonly: true
    length: 2000
    description: ç«äº‰å¯¹æ‰‹åˆ†æå’Œå·®å¼‚åŒ–å»ºè®®

# Relationships
relationships:
  - name: Contracts
    type: hasMany
    object: Contract
    foreignKey: OpportunityId
    label: åˆåŒ

# List Views
listViews:
  - name: All
    label: æ‰€æœ‰å•†æœº
    filters: []
    columns:
      - Name
      - AccountId
      - Amount
      - CloseDate
      - Stage
      - Probability
      - OwnerId
      
  - name: MyOpportunities
    label: æˆ‘çš„å•†æœº
    filters:
      - field: OwnerId
        operator: equals
        value: $currentUser
    columns:
      - Name
      - AccountId
      - Amount
      - CloseDate
      - Stage
      - NextStep
      
  - name: ClosingThisQuarter
    label: æœ¬å­£åº¦æˆäº¤
    filters:
      - field: CloseDate
        operator: thisQuarter
    sortBy: CloseDate
    sortOrder: asc
    columns:
      - Name
      - AccountId
      - Amount
      - CloseDate
      - Stage
      - Probability
      
  - name: Won
    label: å·²æˆäº¤
    filters:
      - field: Stage
        operator: equals
        value: Closed Won
    columns:
      - Name
      - AccountId
      - Amount
      - CloseDate
      - OwnerId
      
  - name: HighValue
    label: é«˜ä»·å€¼å•†æœº
    filters:
      - field: Amount
        operator: greaterThan
        value: 1000000
      - field: IsClosed
        operator: equals
        value: false
    columns:
      - Name
      - AccountId
      - Amount
      - Stage
      - CloseDate
      - Probability

# Page Layout
pageLayout:
  sections:
    - label: å•†æœºä¿¡æ¯
      columns: 2
      fields:
        - Name
        - AccountId
        - ContactId
        - Amount
        - CloseDate
        - Stage
        - Probability
        - Type
        - OwnerId
        
    - label: é”€å”®ç­–ç•¥
      columns: 2
      fields:
        - LeadSource
        - NextStep
        - ForecastCategory
        - ProductInterest
        - Quantity
        - Discount
        
    - label: åˆ†æä¸ç«äº‰
      columns: 1
      fields:
        - CompetitorAnalysis
        - Description
        
    - label: AI èµ¢å•åˆ†æ
      columns: 1
      fields:
        - AISummary
        - AINextStepSuggestion
        - AIWinProbability
        - AIRiskFactors
        - AICompetitiveIntel
        
    - label: ç»“æœ
      columns: 2
      fields:
        - LossReason
      visibleWhen:
        field: Stage
        operator: equals
        value: Closed Lost

# Validation Rules
validationRules:
  - name: RequireLossReasonWhenLost
    errorMessage: å•†æœºå¤±è´¥æ—¶å¿…é¡»å¡«å†™å¤±è´¥åŸå› 
    formula: |
      AND(
        Stage = "Closed Lost",
        ISBLANK(LossReason)
      )
      
  - name: CloseDateInFuture
    errorMessage: é¢„è®¡æˆäº¤æ—¥æœŸä¸èƒ½æ—©äºä»Šå¤©
    formula: |
      AND(
        NOT(IsClosed),
        CloseDate < TODAY()
      )

# Triggers
triggers:
  - name: OpportunityStageChange
    event: afterUpdate
    file: triggers/OpportunityTrigger.ts
    conditions:
      - field: Stage
        changed: true
        
  - name: OpportunityAIAnalysis
    event: afterInsert, afterUpdate
    description: AI åˆ†æå•†æœºå¹¶ç”Ÿæˆèµ¢å•å»ºè®®
