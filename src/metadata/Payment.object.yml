# Payment Object Definition
# å›æ¬¾ç®¡ç† - Finance Domain
# Follows @objectstack/spec standard for enterprise CRM

name: Payment
label: å›æ¬¾
labelPlural: å›æ¬¾
icon: money-bill-wave
description: å›æ¬¾è®¡åˆ’ã€å‘ç¥¨è®°å½•å’Œé€¾æœŸæé†’

# Enable core features
features:
  searchable: true
  trackFieldHistory: true
  enableActivities: true
  enableNotes: true
  enableAttachments: true

# Field Definitions
fields:
  # Basic Information
  - name: PaymentNumber
    type: autoNumber
    label: å›æ¬¾ç¼–å·
    format: PAY-{YYYY}-{MM}-{0000}
    readonly: true
    searchable: true
    
  - name: Name
    type: text
    label: å›æ¬¾åç§°
    required: true
    searchable: true
    length: 255
    
  - name: Type
    type: select
    label: å›æ¬¾ç±»å‹
    required: true
    options:
      - label: ğŸ’° é¦–æ¬¾
        value: Down Payment
      - label: ğŸ¯ é‡Œç¨‹ç¢‘ä»˜æ¬¾
        value: Milestone Payment
      - label: ğŸ“¦ äº¤ä»˜ä»˜æ¬¾
        value: Delivery Payment
      - label: âœ… éªŒæ”¶ä»˜æ¬¾
        value: Acceptance Payment
      - label: ğŸ”„ å°¾æ¬¾
        value: Final Payment
      - label: ğŸ“… å®šæœŸä»˜æ¬¾
        value: Recurring Payment
      - label: ğŸ”§ ç»´ä¿è´¹
        value: Maintenance Fee
      - label: ğŸ å…¶ä»–
        value: Other
        
  - name: Status
    type: select
    label: çŠ¶æ€
    required: true
    defaultValue: Planned
    options:
      - label: ğŸ“‹ è®¡åˆ’ä¸­
        value: Planned
      - label: ğŸ“§ å·²å¼€ç¥¨
        value: Invoiced
      - label: âœ… å·²æ”¶æ¬¾
        value: Received
      - label: â° é€¾æœŸ
        value: Overdue
      - label: ğŸš« æ ¸é”€
        value: Written Off
      - label: âŒ å–æ¶ˆ
        value: Cancelled
        
  # Related Records
  - name: AccountId
    type: lookup
    label: å®¢æˆ·
    referenceTo: Account
    required: true
    
  - name: OpportunityId
    type: lookup
    label: å…³è”å•†æœº
    referenceTo: Opportunity
    
  - name: ContractId
    type: lookup
    label: å…³è”åˆåŒ
    referenceTo: Contract
    required: true
    
  - name: QuoteId
    type: lookup
    label: å…³è”æŠ¥ä»·å•
    referenceTo: Quote
    
  # Amount
  - name: PlannedAmount
    type: currency
    label: è®¡åˆ’é‡‘é¢
    precision: 2
    required: true
    
  - name: ReceivedAmount
    type: currency
    label: å®æ”¶é‡‘é¢
    precision: 2
    
  - name: UnpaidAmount
    type: currency
    label: æœªä»˜é‡‘é¢
    precision: 2
    readonly: true
    description: è®¡åˆ’é‡‘é¢ - å®æ”¶é‡‘é¢
    
  - name: Currency
    type: select
    label: å¸ç§
    required: true
    defaultValue: CNY
    options:
      - label: äººæ°‘å¸ (CNY)
        value: CNY
      - label: ç¾å…ƒ (USD)
        value: USD
      - label: æ¬§å…ƒ (EUR)
        value: EUR
      - label: è‹±é•‘ (GBP)
        value: GBP
        
  # Dates
  - name: PlannedDate
    type: date
    label: è®¡åˆ’å›æ¬¾æ—¥æœŸ
    required: true
    
  - name: ActualDate
    type: date
    label: å®é™…å›æ¬¾æ—¥æœŸ
    
  - name: DaysOverdue
    type: number
    label: é€¾æœŸå¤©æ•°
    precision: 0
    readonly: true
    
  # Invoice
  - name: InvoiceNumber
    type: text
    label: å‘ç¥¨å·
    length: 50
    searchable: true
    
  - name: InvoiceDate
    type: date
    label: å¼€ç¥¨æ—¥æœŸ
    
  - name: InvoiceAmount
    type: currency
    label: å‘ç¥¨é‡‘é¢
    precision: 2
    
  # Payment Method
  - name: PaymentMethod
    type: select
    label: ä»˜æ¬¾æ–¹å¼
    options:
      - label: é“¶è¡Œè½¬è´¦
        value: Bank Transfer
      - label: æ”¯ç¥¨
        value: Check
      - label: ç°é‡‘
        value: Cash
      - label: ä¿¡ç”¨å¡
        value: Credit Card
      - label: æ”¯ä»˜å®
        value: Alipay
      - label: å¾®ä¿¡æ”¯ä»˜
        value: WeChat Pay
      - label: å…¶ä»–
        value: Other
        
  - name: ReferenceNumber
    type: text
    label: äº¤æ˜“å‚è€ƒå·
    length: 100
    description: é“¶è¡Œæµæ°´å·æˆ–äº¤æ˜“å‡­è¯å·
    
  # Bank Info
  - name: BankName
    type: text
    label: æ”¶æ¬¾é“¶è¡Œ
    length: 255
    
  - name: BankAccount
    type: text
    label: æ”¶æ¬¾è´¦å·
    length: 50
    
  # Reminder
  - name: ReminderSent
    type: checkbox
    label: å·²å‘é€æé†’
    defaultValue: false
    
  - name: ReminderSentDate
    type: datetime
    label: æé†’å‘é€æ—¶é—´
    readonly: true
    
  - name: LastReminderDate
    type: datetime
    label: æœ€åæé†’æ—¶é—´
    readonly: true
    
  # Notes
  - name: Description
    type: textarea
    label: å¤‡æ³¨
    length: 5000
    
  - name: OverdueReason
    type: textarea
    label: é€¾æœŸåŸå› 
    length: 2000
    
  # Collection
  - name: CollectionAssignee
    type: lookup
    label: å‚¬æ¬¾è´Ÿè´£äºº
    referenceTo: User
    description: é€¾æœŸæ—¶æŒ‡æ´¾å‚¬æ¬¾äºº
    
  - name: CollectionPriority
    type: select
    label: å‚¬æ¬¾ä¼˜å…ˆçº§
    options:
      - label: ğŸ”´ é«˜
        value: High
      - label: ğŸŸ¡ ä¸­
        value: Medium
      - label: ğŸŸ¢ ä½
        value: Low

# Relationships
relationships:
  - name: Activities
    type: hasMany
    object: Activity
    foreignKey: WhatId
    label: å‚¬æ¬¾æ´»åŠ¨

# List Views
listViews:
  - name: AllPayments
    label: æ‰€æœ‰å›æ¬¾
    filters: []
    columns:
      - PaymentNumber
      - Name
      - Account
      - PlannedAmount
      - ReceivedAmount
      - Status
      - PlannedDate
      - ActualDate
    sortBy: PlannedDate
    sortOrder: desc
    
  - name: MyPayments
    label: æˆ‘çš„å›æ¬¾
    filters:
      - field: OwnerId
        operator: equals
        value: $CurrentUser.Id
    columns:
      - PaymentNumber
      - Name
      - Account
      - PlannedAmount
      - ReceivedAmount
      - Status
      - PlannedDate
    sortBy: PlannedDate
    sortOrder: desc
    
  - name: Planned
    label: è®¡åˆ’ä¸­
    filters:
      - field: Status
        operator: equals
        value: Planned
    columns:
      - PaymentNumber
      - Name
      - Account
      - PlannedAmount
      - PlannedDate
      - Owner
    sortBy: PlannedDate
    sortOrder: asc
    
  - name: Overdue
    label: é€¾æœŸå›æ¬¾
    filters:
      - field: Status
        operator: equals
        value: Overdue
    columns:
      - PaymentNumber
      - Name
      - Account
      - UnpaidAmount
      - PlannedDate
      - DaysOverdue
      - CollectionAssignee
      - CollectionPriority
    sortBy: DaysOverdue
    sortOrder: desc
    
  - name: ThisMonth
    label: æœ¬æœˆå›æ¬¾
    filters:
      - field: PlannedDate
        operator: this_month
    columns:
      - PaymentNumber
      - Name
      - Account
      - PlannedAmount
      - ReceivedAmount
      - Status
      - PlannedDate
    sortBy: PlannedDate
    sortOrder: asc
    
  - name: Received
    label: å·²æ”¶æ¬¾
    filters:
      - field: Status
        operator: equals
        value: Received
      - field: ActualDate
        operator: this_year
    columns:
      - PaymentNumber
      - Name
      - Account
      - ReceivedAmount
      - ActualDate
      - PaymentMethod
    sortBy: ActualDate
    sortOrder: desc

# Page Layout
pageLayout:
  sections:
    - label: å›æ¬¾ä¿¡æ¯
      columns: 2
      fields:
        - PaymentNumber
        - Name
        - Type
        - Status
        - AccountId
        - ContractId
        - OpportunityId
        - QuoteId
        
    - label: é‡‘é¢
      columns: 2
      fields:
        - PlannedAmount
        - ReceivedAmount
        - UnpaidAmount
        - Currency
        
    - label: æ—¥æœŸ
      columns: 2
      fields:
        - PlannedDate
        - ActualDate
        - DaysOverdue
        
    - label: å‘ç¥¨ä¿¡æ¯
      columns: 2
      fields:
        - InvoiceNumber
        - InvoiceDate
        - InvoiceAmount
        
    - label: ä»˜æ¬¾æ–¹å¼
      columns: 2
      fields:
        - PaymentMethod
        - ReferenceNumber
        - BankName
        - BankAccount
        
    - label: å‚¬æ¬¾ç®¡ç†
      columns: 2
      fields:
        - CollectionAssignee
        - CollectionPriority
        - ReminderSent
        - ReminderSentDate
        - LastReminderDate
        
    - label: å¤‡æ³¨
      columns: 1
      fields:
        - Description
        - OverdueReason

# Validation Rules
validationRules:
  - name: ReceivedAmountNotGreaterThanPlanned
    errorMessage: å®æ”¶é‡‘é¢ä¸èƒ½è¶…è¿‡è®¡åˆ’é‡‘é¢
    formula: |
      AND(
        NOT(ISBLANK(ReceivedAmount)),
        ReceivedAmount > PlannedAmount
      )
      
  - name: ActualDateRequiredWhenReceived
    errorMessage: çŠ¶æ€ä¸ºå·²æ”¶æ¬¾æ—¶å¿…é¡»å¡«å†™å®é™…å›æ¬¾æ—¥æœŸ
    formula: |
      AND(
        Status = "Received",
        ISBLANK(ActualDate)
      )
      
  - name: InvoiceNumberRequiredWhenInvoiced
    errorMessage: çŠ¶æ€ä¸ºå·²å¼€ç¥¨æ—¶å¿…é¡»å¡«å†™å‘ç¥¨å·
    formula: |
      AND(
        Status = "Invoiced",
        ISBLANK(InvoiceNumber)
      )
      
  - name: CollectionAssigneeRequiredWhenOverdue
    errorMessage: é€¾æœŸå›æ¬¾å¿…é¡»æŒ‡æ´¾å‚¬æ¬¾è´Ÿè´£äºº
    formula: |
      AND(
        Status = "Overdue",
        ISBLANK(CollectionAssignee)
      )

# Triggers
triggers:
  - name: PaymentOverdueCheck
    event: beforeUpdate
    description: æ£€æŸ¥å¹¶æ›´æ–°é€¾æœŸçŠ¶æ€å’Œé€¾æœŸå¤©æ•°
    
  - name: PaymentReminderScheduler
    event: afterInsert, afterUpdate
    description: å®‰æ’å›æ¬¾æé†’ä»»åŠ¡
    
  - name: ContractPaymentAggregation
    event: afterUpdate
    description: æ›´æ–°åˆåŒçš„å›æ¬¾æ±‡æ€»ä¿¡æ¯
