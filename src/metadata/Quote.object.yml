# Quote Object Definition
# æŠ¥ä»·å•ç®¡ç† (CPQ - Configure, Price, Quote) - Sales Force Automation Domain
# Follows @objectstack/spec standard for enterprise CRM

name: Quote
label: æŠ¥ä»·å•
labelPlural: æŠ¥ä»·å•
icon: file-invoice-dollar
description: å¤æ‚æŠ¥ä»·é…ç½®ã€æŠ˜æ‰£å®¡æ‰¹å’Œ PDF ç”Ÿæˆ

# Enable core features
features:
  searchable: true
  trackFieldHistory: true
  enableActivities: true
  enableNotes: true
  enableAttachments: true
  enableApprovalProcess: true

# Field Definitions
fields:
  # Basic Information
  - name: QuoteNumber
    type: autoNumber
    label: æŠ¥ä»·å•ç¼–å·
    format: Q-{YYYY}-{MM}-{0000}
    readonly: true
    searchable: true
    
  - name: Name
    type: text
    label: æŠ¥ä»·å•åç§°
    required: true
    searchable: true
    length: 255
    
  - name: Status
    type: select
    label: çŠ¶æ€
    required: true
    defaultValue: Draft
    options:
      - label: ğŸ“ è‰ç¨¿
        value: Draft
      - label: ğŸ”„ å®¡æ‰¹ä¸­
        value: In Review
      - label: âœ… å·²æ‰¹å‡†
        value: Approved
      - label: âŒ å·²æ‹’ç»
        value: Rejected
      - label: ğŸ“§ å·²å‘é€
        value: Sent
      - label: ğŸ¤ å®¢æˆ·å·²æ¥å—
        value: Accepted
      - label: ğŸš« å·²å¤±æ•ˆ
        value: Expired
        
  # Related Records
  - name: OpportunityId
    type: lookup
    label: å…³è”å•†æœº
    referenceTo: Opportunity
    required: true
    
  - name: AccountId
    type: lookup
    label: å®¢æˆ·
    referenceTo: Account
    required: true
    
  - name: ContactId
    type: lookup
    label: è”ç³»äºº
    referenceTo: Contact
    
  - name: PricebookId
    type: lookup
    label: ä»·æ ¼è¡¨
    referenceTo: Pricebook
    required: true
    
  # Dates
  - name: QuoteDate
    type: date
    label: æŠ¥ä»·æ—¥æœŸ
    required: true
    defaultValue: $TODAY
    
  - name: ExpirationDate
    type: date
    label: æœ‰æ•ˆæœŸè‡³
    required: true
    
  - name: ValidityPeriodDays
    type: number
    label: æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
    precision: 0
    defaultValue: 30
    readonly: true
    
  # Pricing
  - name: Subtotal
    type: currency
    label: å°è®¡
    precision: 2
    readonly: true
    description: æ‰€æœ‰äº§å“è¡Œé¡¹ç›®é‡‘é¢æ€»å’Œ
    
  - name: DiscountPercent
    type: percent
    label: æŠ˜æ‰£ç‡
    defaultValue: 0
    
  - name: DiscountAmount
    type: currency
    label: æŠ˜æ‰£é‡‘é¢
    precision: 2
    readonly: true
    
  - name: TaxPercent
    type: percent
    label: ç¨ç‡
    defaultValue: 0
    
  - name: TaxAmount
    type: currency
    label: ç¨é¢
    precision: 2
    readonly: true
    
  - name: ShippingHandling
    type: currency
    label: è¿è´¹
    precision: 2
    defaultValue: 0
    
  - name: TotalPrice
    type: currency
    label: æ€»ä»·
    precision: 2
    readonly: true
    description: å°è®¡ - æŠ˜æ‰£ + ç¨é¢ + è¿è´¹
    
  # Payment Terms
  - name: PaymentTerms
    type: select
    label: ä»˜æ¬¾æ¡æ¬¾
    options:
      - label: é¢„ä»˜å…¨æ¬¾
        value: Full Prepayment
      - label: 30% é¢„ä»˜ï¼Œ70% éªŒæ”¶å
        value: 30/70 Split
      - label: 50% é¢„ä»˜ï¼Œ50% éªŒæ”¶å
        value: 50/50 Split
      - label: éªŒæ”¶å 30 å¤©
        value: Net 30
      - label: éªŒæ”¶å 60 å¤©
        value: Net 60
      - label: éªŒæ”¶å 90 å¤©
        value: Net 90
      - label: åˆ†æœŸä»˜æ¬¾
        value: Installments
      - label: å…¶ä»–
        value: Other
        
  - name: DeliveryTerms
    type: select
    label: äº¤ä»˜æ¡æ¬¾
    options:
      - label: ç°åœºäº¤ä»˜
        value: On-site Delivery
      - label: è¿œç¨‹äº¤ä»˜
        value: Remote Delivery
      - label: äº‘ç«¯éƒ¨ç½²
        value: Cloud Deployment
      - label: é‚®å¯„
        value: Shipping
      - label: æ•°å­—ä¸‹è½½
        value: Digital Download
      - label: å…¶ä»–
        value: Other
        
  # Shipping Address
  - name: ShippingStreet
    type: text
    label: æ”¶è´§åœ°å€
    length: 255
    
  - name: ShippingCity
    type: text
    label: æ”¶è´§åŸå¸‚
    length: 40
    
  - name: ShippingState
    type: text
    label: æ”¶è´§çœ/å·
    length: 80
    
  - name: ShippingPostalCode
    type: text
    label: æ”¶è´§é‚®ç¼–
    length: 20
    
  - name: ShippingCountry
    type: text
    label: æ”¶è´§å›½å®¶
    length: 80
    
  # Billing Address
  - name: BillingStreet
    type: text
    label: è´¦å•åœ°å€
    length: 255
    
  - name: BillingCity
    type: text
    label: è´¦å•åŸå¸‚
    length: 40
    
  - name: BillingState
    type: text
    label: è´¦å•çœ/å·
    length: 80
    
  - name: BillingPostalCode
    type: text
    label: è´¦å•é‚®ç¼–
    length: 20
    
  - name: BillingCountry
    type: text
    label: è´¦å•å›½å®¶
    length: 80
    
  # Approval
  - name: ApprovalStatus
    type: select
    label: å®¡æ‰¹çŠ¶æ€
    readonly: true
    options:
      - label: æœªæäº¤
        value: Not Submitted
      - label: å¾…å®¡æ‰¹
        value: Pending
      - label: å·²æ‰¹å‡†
        value: Approved
      - label: å·²æ‹’ç»
        value: Rejected
      - label: å·²æ’¤å›
        value: Recalled
        
  - name: ApprovalLevel
    type: number
    label: å®¡æ‰¹å±‚çº§
    precision: 0
    readonly: true
    description: éœ€è¦çš„å®¡æ‰¹çº§åˆ«ï¼ˆåŸºäºæŠ˜æ‰£ç‡ï¼‰
    
  - name: ApprovedBy
    type: lookup
    label: æ‰¹å‡†äºº
    referenceTo: User
    readonly: true
    
  - name: ApprovedDate
    type: datetime
    label: æ‰¹å‡†æ—¥æœŸ
    readonly: true
    
  # Additional Info
  - name: Description
    type: textarea
    label: æè¿°
    length: 32000
    
  - name: InternalNotes
    type: textarea
    label: å†…éƒ¨å¤‡æ³¨
    length: 5000
    description: ä»…å†…éƒ¨å¯è§
    
  # PDF Generation
  - name: PDFGeneratedDate
    type: datetime
    label: PDF ç”Ÿæˆæ—¶é—´
    readonly: true
    
  - name: PDFUrl
    type: url
    label: PDF é“¾æ¥
    readonly: true
    
  # AI Enhancement Fields
  - name: AIRecommendedBundle
    type: textarea
    label: AI æ¨èäº§å“ç»„åˆ
    readonly: true
    length: 2000
    description: æ ¹æ®å®¢æˆ·é¢„ç®—è‡ªåŠ¨æ¨èäº§å“ç»„åˆ
    
  - name: AIOptimalDiscount
    type: percent
    label: AI å»ºè®®æŠ˜æ‰£
    readonly: true
    description: åŸºäºå†å²æ•°æ®çš„æœ€ä¼˜æŠ˜æ‰£å»ºè®®
    
  - name: AIWinProbability
    type: percent
    label: AI é¢„æµ‹èµ¢å•ç‡
    readonly: true
    description: åŸºäºæŠ¥ä»·æ–¹æ¡ˆçš„èµ¢å•æ¦‚ç‡
    
  - name: AIPricingAnalysis
    type: textarea
    label: AI å®šä»·åˆ†æ
    readonly: true
    length: 2000
    description: ä»·æ ¼ç«äº‰åŠ›åˆ†æå’Œå»ºè®®

# Relationships
relationships:
  - name: QuoteLineItems
    type: hasMany
    object: QuoteLineItem
    foreignKey: QuoteId
    label: æŠ¥ä»·å•æ˜ç»†
    
  - name: Contracts
    type: hasMany
    object: Contract
    foreignKey: QuoteId
    label: å…³è”åˆåŒ

# List Views
listViews:
  - name: AllQuotes
    label: æ‰€æœ‰æŠ¥ä»·å•
    filters: []
    columns:
      - QuoteNumber
      - Name
      - Account
      - TotalPrice
      - Status
      - QuoteDate
      - ExpirationDate
    sortBy: QuoteDate
    sortOrder: desc
    
  - name: MyQuotes
    label: æˆ‘çš„æŠ¥ä»·å•
    filters:
      - field: OwnerId
        operator: equals
        value: $CurrentUser.Id
    columns:
      - QuoteNumber
      - Name
      - Account
      - TotalPrice
      - Status
      - ExpirationDate
    sortBy: QuoteDate
    sortOrder: desc
    
  - name: DraftQuotes
    label: è‰ç¨¿
    filters:
      - field: Status
        operator: equals
        value: Draft
    columns:
      - QuoteNumber
      - Name
      - Account
      - TotalPrice
      - QuoteDate
      - Owner
    sortBy: QuoteDate
    sortOrder: desc
    
  - name: PendingApproval
    label: å¾…å®¡æ‰¹
    filters:
      - field: ApprovalStatus
        operator: equals
        value: Pending
    columns:
      - QuoteNumber
      - Name
      - Account
      - TotalPrice
      - DiscountPercent
      - ApprovalLevel
      - Owner
    sortBy: QuoteDate
    sortOrder: asc
    
  - name: Approved
    label: å·²æ‰¹å‡†
    filters:
      - field: ApprovalStatus
        operator: equals
        value: Approved
      - field: Status
        operator: notIn
        value: [Accepted, Expired]
    columns:
      - QuoteNumber
      - Name
      - Account
      - TotalPrice
      - ApprovedDate
      - ExpirationDate
    sortBy: ApprovedDate
    sortOrder: desc
    
  - name: Expiring
    label: å³å°†åˆ°æœŸ
    filters:
      - field: ExpirationDate
        operator: next_n_days
        value: 7
      - field: Status
        operator: notIn
        value: [Accepted, Expired]
    columns:
      - QuoteNumber
      - Name
      - Account
      - TotalPrice
      - ExpirationDate
      - Owner
    sortBy: ExpirationDate
    sortOrder: asc

# Page Layout
pageLayout:
  sections:
    - label: æŠ¥ä»·å•ä¿¡æ¯
      columns: 2
      fields:
        - QuoteNumber
        - Name
        - Status
        - OpportunityId
        - AccountId
        - ContactId
        - PricebookId
        
    - label: æ—¥æœŸ
      columns: 2
      fields:
        - QuoteDate
        - ExpirationDate
        - ValidityPeriodDays
        
    - label: é‡‘é¢
      columns: 2
      fields:
        - Subtotal
        - DiscountPercent
        - DiscountAmount
        - TaxPercent
        - TaxAmount
        - ShippingHandling
        - TotalPrice
        
    - label: ä»˜æ¬¾ä¸äº¤ä»˜
      columns: 2
      fields:
        - PaymentTerms
        - DeliveryTerms
        
    - label: æ”¶è´§åœ°å€
      columns: 2
      fields:
        - ShippingStreet
        - ShippingCity
        - ShippingState
        - ShippingPostalCode
        - ShippingCountry
        
    - label: è´¦å•åœ°å€
      columns: 2
      fields:
        - BillingStreet
        - BillingCity
        - BillingState
        - BillingPostalCode
        - BillingCountry
        
    - label: å®¡æ‰¹ä¿¡æ¯
      columns: 2
      fields:
        - ApprovalStatus
        - ApprovalLevel
        - ApprovedBy
        - ApprovedDate
        
    - label: PDF æ–‡æ¡£
      columns: 2
      fields:
        - PDFGeneratedDate
        - PDFUrl
        
    - label: AI æ™ºèƒ½æŠ¥ä»·
      columns: 1
      fields:
        - AIRecommendedBundle
        - AIOptimalDiscount
        - AIWinProbability
        - AIPricingAnalysis
        
    - label: å¤‡æ³¨
      columns: 1
      fields:
        - Description
        - InternalNotes

# Validation Rules
validationRules:
  - name: ExpirationAfterQuoteDate
    errorMessage: æœ‰æ•ˆæœŸè‡³å¿…é¡»æ™šäºæŠ¥ä»·æ—¥æœŸ
    formula: |
      AND(
        NOT(ISBLANK(QuoteDate)),
        NOT(ISBLANK(ExpirationDate)),
        ExpirationDate <= QuoteDate
      )
      
  - name: HighDiscountRequiresApproval
    errorMessage: æŠ˜æ‰£ç‡è¶…è¿‡ 20% éœ€è¦å®¡æ‰¹
    formula: |
      AND(
        DiscountPercent > 0.20,
        ApprovalStatus != "Approved"
      )
      
  - name: ApprovedQuoteReadOnly
    errorMessage: å·²æ‰¹å‡†çš„æŠ¥ä»·å•ä¸èƒ½ä¿®æ”¹é‡‘é¢
    formula: |
      AND(
        ApprovalStatus = "Approved",
        OR(
          Subtotal != PRIORVALUE(Subtotal),
          DiscountPercent != PRIORVALUE(DiscountPercent),
          TaxPercent != PRIORVALUE(TaxPercent)
        )
      )

# Triggers
triggers:
  - name: QuotePriceCalculation
    event: beforeInsert, beforeUpdate
    description: è‡ªåŠ¨è®¡ç®—æŠ˜æ‰£ã€ç¨é¢å’Œæ€»ä»·
    
  - name: QuoteApprovalRouting
    event: afterUpdate
    description: æ ¹æ®æŠ˜æ‰£ç‡è‡ªåŠ¨è·¯ç”±å®¡æ‰¹æµç¨‹
    
  - name: QuotePDFGeneration
    event: afterUpdate
    description: çŠ¶æ€å˜ä¸ºå·²æ‰¹å‡†æ—¶è‡ªåŠ¨ç”Ÿæˆ PDF
    
  - name: QuoteAIRecommendation
    event: afterInsert, afterUpdate
    description: AI åˆ†æå¹¶ç”Ÿæˆäº§å“ç»„åˆå»ºè®®
